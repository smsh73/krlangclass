// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id         String   @id @default(cuid())
  firstName  String   @map("first_name")
  level      String   @default("Beginner") // Beginner, Intermediate, Professional
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  sessions         Session[]
  gameScores       GameScore[]
  levelTests       LevelTest[]
  interactiveSessions InteractiveSession[]

  @@map("users")
}

model Session {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  token     String   @unique
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model Curriculum {
  id          String   @id @default(cuid())
  title       String
  topic       String?
  difficulty  String?  // Beginner, Intermediate, Professional
  description String?  @db.Text
  content     String   @db.Text
  source      String?  // "document" or "ai_generated"
  documentId  String?  @map("document_id")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  document CurriculumDocument? @relation(fields: [documentId], references: [id], onDelete: SetNull)

  @@map("curriculum")
}

model CurriculumDocument {
  id          String   @id @default(cuid())
  filename    String
  originalName String  @map("original_name")
  mimeType    String   @map("mime_type")
  content     Bytes    // 원본 파일 바이너리 데이터
  createdAt   DateTime @default(now()) @map("created_at")

  curriculum Curriculum?

  @@map("curriculum_documents")
}

model InteractiveSession {
  id          String   @id @default(cuid())
  userId      String   @map("user_id")
  topic       String
  difficulty  String
  messages    Json     // 대화 메시지 기록
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("interactive_sessions")
}

model GameScore {
  id          String   @id @default(cuid())
  userId      String   @map("user_id")
  gameType    String   @map("game_type") // "typing" or "speaking"
  level       Int      // 1-10
  score       Int
  wordsCompleted Int    @map("words_completed")
  completedAt DateTime @default(now()) @map("completed_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("game_scores")
}

model LevelTest {
  id          String   @id @default(cuid())
  userId      String   @map("user_id")
  questions   Json     // 테스트 문제들
  answers     Json     // 사용자 답변들
  result      String   // Beginner, Intermediate, Professional
  score       Float?
  createdAt   DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("level_tests")
}

model AdminUser {
  id        String   @id @default(cuid())
  username  String   @unique
  password  String   // bcrypt 해시
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("admin_users")
}

model AdminSetting {
  id        String   @id @default(cuid())
  key       String   @unique
  value     String   @db.Text
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("admin_settings")
}

model AdminAccessLog {
  id        String   @id @default(cuid())
  adminId   String?  @map("admin_id")
  action    String
  details   Json?
  ipAddress String?  @map("ip_address")
  createdAt DateTime @default(now()) @map("created_at")

  @@map("admin_access_logs")
}
